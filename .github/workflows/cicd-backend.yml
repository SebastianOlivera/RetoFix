name: CI/CD QR Backend

on:
  pull_request:
    branches: [ main ]

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    env:
      ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}

      KUBE_CLUSTER_NAME: ${{ secrets.KUBE_CLUSTER_NAME }}
      KUBE_USER_NAME: ${{ secrets.KUBE_USER_NAME }}
      KUBE_CONTEXT_NAME: ${{ secrets.KUBE_CONTEXT_NAME }}
      KUBE_TOKEN: ${{ secrets.KUBE_TOKEN }}
      KUBE_APISERVER: ${{ secrets.KUBE_API_SERVER || secrets.KUBE_APISERVER }}

      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -t $ACR_LOGIN_SERVER/qr-backend:latest .

      - name: Push Docker image
        run: |
          docker push $ACR_LOGIN_SERVER/qr-backend:latest

      - name: Install kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl

      - name: Configure kubeconfig
        run: |
          kubectl config set-cluster "$KUBE_CLUSTER_NAME" --server="$KUBE_APISERVER"
          kubectl config set-credentials "$KUBE_USER_NAME" --token="$KUBE_TOKEN"
          kubectl config set-context "$KUBE_CONTEXT_NAME" --cluster="$KUBE_CLUSTER_NAME" --user="$KUBE_USER_NAME"
          kubectl config use-context "$KUBE_CONTEXT_NAME"

      - name: Apply Kubernetes manifests
        run: |
          envsubst < k8s-backend-db-secret.yaml > k8s-backend-db-secret.rendered.yaml
          kubectl apply -f k8s-backend-db-secret.rendered.yaml

          envsubst < k8s-backend.yaml > k8s-backend.rendered.yaml
          kubectl apply -f k8s-backend.rendered.yaml

      - name: Restart backend deployment to use new image
        run: |
          kubectl -n goland-qr rollout restart deployment qr-backend
          if ! kubectl -n goland-qr rollout status deployment qr-backend --timeout=180s; then
            echo "‚ö†Ô∏è  El rollout tard√≥ m√°s de 3 minutos, pero el restart ya fue disparado."
          fi

      - name: Notify Discord - deploy OK
        if: success()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GOLAND }}
        with:
          args: |
            üöÄ **Deploy exitoso**

            üì¶ Servicio: **qr-backend**
            üåø Branch: **main**
            üîñ Commit: `${{ github.sha }}`
            üü¢ Estado: **OK**

      - name: Notify Discord - deploy FAILED
        if: failure()
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GOLAND }}
        with:
          args: |
            ‚ùå **Deploy fallido**

            üì¶ Servicio: **qr-backend**
            üåø Branch: **main**
            üîñ Commit: `${{ github.sha }}`
            üîó Ver detalles: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

