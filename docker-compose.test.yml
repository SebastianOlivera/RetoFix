# =============================================================================
# Docker Compose para ejecutar pruebas de integraci칩n
# Este archivo va en el repo de qr-backend
# =============================================================================
# 
# Uso:
#   docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit
#
# Variables de entorno requeridas:
#   - QA_REPO_URL: URL del repo de pruebas QA (default: se configura en CI)
#   - QA_REPO_BRANCH: Branch del repo QA a usar (default: main)
#   - TEST_TYPE: Tipo de pruebas a ejecutar (api, e2e, performance, all)
# =============================================================================

version: '3.8'

services:
  # ============================================
  # Base de datos PostgreSQL
  # ============================================
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: qr_user
      POSTGRES_PASSWORD: qr_password
      POSTGRES_DB: qr_database
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qr_user -d qr_database"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  # ============================================
  # Backend QR (tu aplicaci칩n Python)
  # ============================================
  qr-backend:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Configuraci칩n de la app
      APP_ENV: test
      # URL con psycopg2 driver (como lo requiere tu backend)
      DATABASE_URL: postgresql+psycopg2://qr_user:qr_password@postgres:5432/qr_database
      # Variables alternativas por si las usa
      DB_USER: qr_user
      DB_PASSWORD: qr_password
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_NAME: qr_database
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      # Tu backend usa "/" no "/health" - usamos python porque curl no est치 instalado
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - test-network

  # ============================================
  # Runner de pruebas QA
  # ============================================
  qa-runner:
    build:
      context: ${QA_PROJECT_PATH:-./.qa-tests}
      dockerfile: Dockerfile
    environment:
      TEST_TYPE: ${TEST_TYPE:-all}
      API_BASE_URL: http://qr-backend:8000
      REPORT_DIR: /qa/reports
    volumes:
      # Montar directorio para extraer reportes
      - ./test-reports:/qa/reports
    depends_on:
      qr-backend:
        condition: service_healthy
    networks:
      - test-network

networks:
  test-network:
    driver: bridge

